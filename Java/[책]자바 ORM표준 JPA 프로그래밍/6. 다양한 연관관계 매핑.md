> 출처 : 자바 ORM 표준 JPA 프로그래밍 읽으면서 정리  

# 6. 다양한 연관관계 매핑
- 다중성
  * 다대일(@ManyToOne) 
  * 일대다(@OneToMany) 
  * 일대일(@OneToOne) 
  * 다대다(@ManyToMany) 
  
- 단방향, 양방향
- 연관관계의 주인

다중성과 단방향, 양방향을 고려한 모든 연관관계
- 다대일 : 단방향, 양방향
- 일대다 : 단방향, 양방향
- 일대일 : 주 테이블 단방향, 양방향
- 일대일 : 대상 테이블 단방향, 양방향
- 다대다 : 단방향, 양방향

## 6.1 다대일
### 6.1.1 다대일 단방향 [N:1]
### 6.1.2 다대일 양방향 [N:1, 1:N]
- 양방향은 외래 키가 있는 쪽이 연관관계의 주인이다.
- 양방향 연관관계는 항상 서로를 참조해야 한다.

## 6.2 일대다
### 6.2.1 일대다 단방향 [1:N]
일대다 단방향 관계는 약간 특이한데, Team.members로 회원 테이블의 TEAM_ID 외래 키를 관리한다.
보통 자신이 매핑한 테이블의 외래키를 관리하는데, 이 매핑은 반대쪽 테이블에 잇는 외래 키를 관리한다.

- 일대다 단방향 매핑의 단점
일대다 단방향 매핑의 단점은 매핑한 객체가 관리하는 외래 키가 다른 테이블에 있다는 점이다.
본인 테이블에 외래 키가 있으면 엔티티의 저장과 연관관계 처리를 INSERT SQL 한 번으로 끝낼 수 있찌만,
다른 테이블에 외래키가 있으면 연관관계 처리을 위한 UPDATE SQL을 추가로 실행해야한다.
  
```java
public void testSave() {
    
    Member member1 = new Member("member1");
    Member member2 = new Member("member2");
    
    Team team1 = new Team("team1");
    team1.getMembers().add(member1);
    team1.getMembers().add(member2);
    
    em.persist(member1); //INSERT-member1
    em.persist(member2); //INSERT-member2
    em.persist(team1);   //INSERT-team1, UPDATE-member1.fk,UDATE-member2.fk
        
    transcation.commit();
}
```

- 일대다 단방향 매핑보다는 다대일 양방향 매핑을 사용하자

### 6.2.2 일대다 양방향 [1:N, N:1]
일대다 양방향 매핑은 존재하지 않는다. 다대일 양방향 매핑을 사용해야 한다.
@ManyToOne에는 mappedBy 속성이 없다.  
그렇다고 일대다 양방향 매핑이 완전히 불가능한 것은 아니다. 일대다 단방향 매핑 반대편에 같은 외래 키를 사용하는
다대일 단방향 매핑을 읽기 전용으로 하나 추가하면 된다. @JoinColumn(name = "TEAM_ID", insertable = false , unpatable = false)

## 6.3 일대일[1:1]
일대일 관계는 양쪽이 서로 하나의 관계만 가진다.

- 일대일 관계는 그 반대도 일대일 관계다.
- 테이블 관계에서 일대다,다대일은 항상 다(N)쪽이 외래 키를 가진다. 
반면에 일대일 관계는 주 테이블이나 대상 테이블 둘중 어느곳이나 외래키를 가질 수 있다.

일대일 관계는 주 테이블이나 대상 테이블 중에 누가 외래 키를 가질지 선택해야 한다.

### 6.3.1 주 테이블에 외래 키
일대일 관계를 구성할 때 객체지향 개발자들은 주테이블에 외래 키가 있는 것을 선호한다.
JPA도 주 테이블에 외래 키가 있으면 좀 더 편리하게 매핑 할 수 있다.

### 6.3.2 대상 테이블에 외래 키
단방향관계는 JPA에서 지원하지 않는다.

양방향 관계로 만들고 Locker를 연관관계의 주인으로 설정해야 한다.

## 6.4 다대다 [N:N]
관계형 데이터베이스는 정규화된 테이블 2개로 다대다 관계를 표현할 수 없다.
그래도 보통 다대다 관계를 일대다, 다대일 관계로 풀어내는 연결 테이블을 사용한다.

그런데 객체는 테이블과 다르게 객체 2개로 다대다 관계를 만들 수 있다. 
예를 들어 회원 객체는 컬렉션을 사용해서 상품들을 참조하면 되고 반대로 삼품들도 컬렉션을 사용해서 회원들을 참조하면 된다.

### 6.4.1 다대다:단방향
- @JoinTable.name : 연결 테이블을 지정한다.
- @JoinTable.joinColumns : 현재 방향인 회원과 매핑할 조인 컬럼 정보를 지정한다.
- @JoinTable.inverseJoinColumns : 반대 방향인 상품과 매핑할 조인 컬럼 정보를 지정한다.

### 6.4.2 다대다:양방향
다대다 매핑이므로 역방향도 @ManyToMany를 사용한다. 그리고 양쪽 중 원하는 곳에 mappedBy로 연관관계의 주인을 지정한다.

### 6.4.3 다대다:매핑 한계와 극복, 연결 엔티티 사용
@ManyToMany를 사용하면 연결 테이블을 자동으로 처리해주므로 도메인 모델이 단순해지고 여러가지로 편리하다.

복합기본키  
@IdClass를 사용해서 식별자 클래스를 지정  
- 복합 키는 별도의 식별자 클래스로 만들어야 한다.
- Serializable을 구현해야한다.
- equals와 hashCode 메소드를 구현해야한다.
- 기본생성자가 있어야한다.
- 식별자 클래스는 public 이어야 한다.
- @IdClass를 사용하는 방법 외에 @EmbeddedId를 사용한느 방법도 있다.

식별관계  
부모 테이블의 기본 키를 받아서 자신의 기본키 + 외래 키로 사용하는것을 데이터베이스 용어로 식별 관계라 한다.

### 6.4.4 다대다:새로운 기본키 사용
식별자 코드를 사용하지 않아서 코드가 한결 단순해짐  
새로운 기본 키를 사용해서 다대다 관계를 풀어내는 것도 좋은 방법이다.

### 6.4.5 다대다 연관관계 정리
- 식별관계 : 받아온 식별자를 기본키 + 외래 키로 사용한다.
- 비식별관계 : 받아온 식별자는 외래 키로만 사용하고 새로운 식별자를 추가한다.

### 6.5 정리


