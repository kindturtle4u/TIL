> 출처 : 자바 ORM 표준 JPA 프로그래밍 읽으면서 정리  

# 13. 웹 애플리케이션과 영속성 관리
컨테이너 환경에서 웹 애플리케이션을 개발할 때 발생할 수 있는 다양한 문제점과 해결 방안을 알아보자

## 13.1 트랜잭션 범위의 영속성 컨텍스트
스프링이나 J2EE 컨테이너 환경에서 JPA를 사용하면 컨테이너가 제공하는 전략을 따라야 한다.

## 13.1.1 스프링 컨테이너의 기본전략
스프링 컨테이너는 **트랜잭션 범위의 영속성 컨텍스트** 전략을 기본으로 사용한다.
트랜잭션의 범위와 영속성 컨테이너의 생존 범위가 같다. 이 전략은 트랜잭션을 시작할 때 영속성 컨텍스트를 생성하고
트랜잭션이 끝날때 영속성 컨텍스트를 종료한다.

## 13.2 준영속 상태와 지연 로딩
변경감지 기능은 영속성 컨텍스트가 살아있는 계층(트랜잭션 범위)까지만 동작하고 
영속성 컨텍스트가 종료된 프리젠테이션 계층에서는 동작하지 않는다.

#### 준영속 상태와 변경감지
프리젠테이션 계층에서 데이터를 수정할 일은 거의 없다. 
따라서 변경 감지 기능이 프르젠테이션 계층에서 동작하지 않는것은 특별히 문제가 되지 않는다.

#### 준영속 상태와 지연로딩
준영속 상태의 가낭 골치 아픈 문제는 지연 로딩 기능이 동작하지 않는다는 점이다.
준영속 상태의 지연 로딩 문제를 해결하는 방법은 크게 2가지가 있다.
- 뷰가 필요한 엔티티를 미리 로딩해두는 방법
- OSIV를 사용해서 엔티티를 항상 영속 상태로 유지하는 방법

### 13.2.1 글로벌 페치 전략 수정
글로벌 페치 전략을 지연로딩에서 즉시 로딩으로 변경하면 된다.

#### 사용하지 않는 엔티티를 로딩한다
#### N+1 문제가 발생한다
JPA를 사용하면서 성능상 가장 조심해야 하는 것이 바로 N+1문제다.
만약 조회한 order 엔티티가 10개이면 member를 조회하는 SQL도 10번 실행한다. 
이처럼 처음 조회한 데이터 수만큼 다시 SQL을 사용해서 조회하는 것을 N+1 문제라 한다.

### 13.2.2 JPQL 페치 조인
이런 N+1문제는 JPQL 페치 조인으로 해결할 수 있다.

#### JPQL 페치 조인의 단점
화면에 맞춘 리포지토리 메소드가 증가할 수 있다. 결국 프리젠테이션 계층이 알게 모르게 데이터 접근 계층을 침범하는 것이다.

### 13.2.3 강제로 초기화
영속성 컨텍스트가 살아있을 때 프리젠테이션 계층이 필요한 엔티티를 강제로 초기화해서 반환하는 방법이다.
프록시 초기화 하는 역할을 서비스 계층이 담당하면 뷰가 필요한 엔티티에 따라 서비스 계층의 로직을 변경해야한다.
은근 슬쩍 프리젠테이션 계층이 서비스 계층을 침범하는 상황이다.

### 13.2.4 FACADE 계층 추가
이것은 프리젠테이션 계층과 서비스 계층 사이에 FACADE 계층을 하나 더 두는 방법이다.
이제부터 뷰를 위한 프록시 초기화는 이곳에서 담당한다.
프록시를 초기화 하려면 영속성 컨텍스트가 필요하므로 FACADE에서 트랜잭션을 시작해야 한다.

### 13.2.5 준영속 상태와 지연 로딩의 문제점

## 13.3 OSIV
OSIV(Open Session In View)는 영속성 컨텍스트를 뷰까지 열어둔다는 뜻이다.
영속성 컨텍스트가 살아있으면 엔티티는 영속상태로 유지된다. 따라서 뷰에서도 지연 로딩을 사용할 수 있다.

### 13.3.1 과거 OSIV: 요청 당 트랜잭션
클라이언트의 요청이 들어오자마자 서블릿 필터나 스프링 인터셉터에서 트랜잭션을 시작하고 요청이 끝날 때 트랜잭션도 끝내는 것이다.

#### 요청당 트랜잭션 방식의 OSIV 문제점
컨트롤러나 뷰같은 프리젠테이션 계층이 엔티티를 변경할 수 있다는 점이다.

프리젠테이션 계층에서 엔티티를 수정하지 못하게 막는 방법들
- 엔티티를 읽기 전용 인터페이스로 제공
- 엔티티 레핑
- DTO만 반환

세가지 방법 모두 코드량이 상당이 증가한다는 단점이 있다.

### 13.3.2 스프링 OSIV: 비즈니스 계층 트랜잭션
스프링 프레임워크의 spring-orm.jar는 다양한 OSIV 클래스를 제공한다.

#### 스프링 OSIV 분석
스프링 프레임워크가 제공하는 OSIV는 비즈느시 계층에서 트랜잭션을 사용하는 OSIV다.
이름 그대로 OSIV를 사용하기는 하지만 트랜잭션은 비즈니스 계층에서만 사용한다는 뜻이다.

#### 트랜잭션 없이 읽기
- 영속성 컨텍스트는 트랜잭션 범위 안에서 엔티티를 조회하고 수정할 수 있다.
- 영속성 컨텍스트는 트랜잭션 범위 밖에서 엔티티를 조회만 할 수 있다. 이것을 트랜잭션 없이 읽기(Nontransactional reads)라 한다.

스프링이 제공하는 비즈니스 계층 트랜잭션 OSIV는 다음과 같은 특징이 있다.
- 영속성 컨텍스트를 프리젠테이션 계층까지 유지한다.
- 프리젠테이션 계층에는 트랜잭션이 없으므로 엔티티를 수정할 수 없다.
- 프리젠테이션 계층에는 트랜잭션이 없지만 트랜잭션 읽기를 사용해서 지연 로딩을 할 수 있다.

#### 스프링 OSIV 주의사항
프리젠테이션 계층에서 엔티티를 수정한 직후 트랜잭션을 시작하는 서비스 계층을 호출하면 문제가 발생한다.
문제를 해결하는 단순한 방법은 트랜잭션이 있는 비즈니스 로직을 모두 호출하고 나서 엔티티를 변경하면 된다.

### 13.3.3 OSIV 정리

## 13.4 너무 엄격한 계층
## 13.5 정리












