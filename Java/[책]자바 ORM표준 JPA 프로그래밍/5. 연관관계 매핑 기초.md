> 출처 : 자바 ORM 표준 JPA 프로그래밍 읽으면서 정리  

# 5. 연관관계 매핑 기초
객체의 참조와 테이블의 외래 키를 매핑하는 것이 이장의 목표다.

- 방향(Direction) : 단방향,양방향이 있다. 회원과 팀이 관계가 있을때 회원->팀 또는 팀->회원 둘 중 한 쪽만 참조하는 것을 단방향 관계라 하고
회원 -> 팀, 팀 -> 회원 양쪽 모두 서로 참조하는 것을 양방향 관계라 한다. 방향은 객체관계에만 존재하고 테이블 관계는 항상 양방향이다.
  
- 다중성(Multiplicity) : 다대일(N:1), 일대다(1:N), 일대일(1:1), 다대다(N:M) 다중성이 있다.
회원과 팀이 관계가 있을 때 여러 회원은 한팀에 속하므로 회원과 팀은 다대일 관계다. 반대로 한팀에 여러 회원이 소속될 수 있으므로
팀과 회원은 일대다 관계다.
  
- 연관관계의 주인(owner) : 객체를 양방향 연관관계로 만들면 연관관계의 주인을 정해야 한다.

## 5.1 단방향 연관관계
- 다대일(N:1)
    * 회원과 팀이 있다. 
    * 회원은 하나의 팀에만 소속될 수 있다.
    * 회원과 팀은 다대일 관계다.
    
- 객체 연관관계  
회원객체와 팀 객체는 단방향 관계다. 회원은 Member.team 필드를 통해서 팀을 알수 있지만 반대로 팀은 회원을 알 수 없다.
  
- 테이블 연관관계  
  회원 테이블과 팀 테이블은 양방향 관계다. 
  회원테이블의 TEAM_ID 외래키를 통해서 회원과 팀을 조인할수 있고 반대로 팀과 회원도 조인할 수 있다.

- 객체 연관관계와 테이블 연관관계의 가장 큰 차이  
참조를 통한 연관관계는 언제나 단방향이다. 객체간 연관관계를 양방향으로 만들고 싶으면 반대쪽에도 필드를 추가해서 참조를 보관해야한다.
이렇게 양쪽에서 서로 참조하는 것을 양방향 연관관계라 한다. 하지만 정확히 이야기하면 이것은 양방향 관계가 아니라 서로 다른 단방향 관계 2개다.
반면에 테이블은 외래 키 하나로 양방향으로 조인할 수 있다.
  
- 객체 연관관계 Vs 테이블 연관관계 정리
    * 객체는 참조로 연관관계를 맺는다.
    * 테이블은 외래 키로 연관관계를 맺는다.
    * 참조를 사용하는 객체의 연관관계는 단방향이다.
    * 외래 키를 사용하는 테이블 연관관계는 양방향이다.
    * 객체를 양방향으로 참조하려면 단방향 연관관계를 2개 만들어야 한다.
        + A -> B (a.b)
        + B -> A (b.a)
        
### 5.1.1 순수한 객체 연관 관계
### 5.1.2 테이블 연관관계
### 5.1.3 객체 관계 매핑
- @ManyToOne  
  다대일(N:1) 관계라는 매핑 정보. 회원과 팀은 다대일 관계다. 
  연관관계를 매핑할 때 이렇게 다중성을 나타내는 어노테이션을 필수로 사용해야한다.
  
- @JoinColumn(name="TEAM_ID")
  조인 컬럼은 외래 키를 매핑할 때 사용한다. 
  
### 5.1.4 @JoinColumn
### 5.1.5 @ManyToOne

## 5.2 연관관계 사용
### 5.2.1 저장
### 5.2.2 조회
- 객체 그래프 탐색(객체 연관관계를 사용한 조회)
- 객체지향 쿼리 사용(JPQL)

### 5.2.3 수정
### 5.2.4 연관관계 제거
member1.setTeam(null);

### 5.2.4 연관관계 삭제
팀1을 삭제하려면 연관관계를 먼저 끊어야 한다.
```java
member1.setTeam(null);
member2.setTeam(null);
em.remove(team);
```

## 5.3 양방향 연관관계
### 5.3.1 양방향 연관관계 매핑
@OneToMany(mappedBy = "team")  
mappedBy 속성은 양방향 매핑일 때 사용하는데 반대쪽 매핑 필드 이름을 값으로 주면 된다.
반대쪽 매핑이 Member.team이므로 team을 값으로 주었따.

### 5.3.2 일대다 컬렉션 조회

## 5.4 연관관계의 주인
@oneToMany만 있으면 되지 mappedBy는 왜 필요할까?  
엄밀히 말하면 객체에는 양방향 연관관계라는 것이 없다. 서로 다른 단방향 연관관계 2개를 애플리케이션 로직으로 잘 묶어서
양방향인 것처럼 보이게 할 뿐이다.
엔티티를 양방향 연관관계로 설정하면 객체의 참조는 둘인데 외래 키는 하나다. 따라서 둘 사이에 차이가 발생한다.
이런차이로 인해 JPA에서는 두 객체 연관관계 중 하나를 정해서 테이블의 외래키를 관리해야 하는데 이것을 연관관계의 주인Owner이라 한다.

### 5.4.1 양방향 매핑의 규칙:연관관계의 주인
연관관계의 주인만이 데이터베이스 연관관계와 매핑되고 외래 키를 관리(등록,수정,삭제) 할 수 있다.
반면에 주인이 아닌 쪽은 읽기만 할 수 있다.

어떤 연관관계를 주인으로 정할지는 mappedBy 속성을 사용하면 된다.
- 주인은 mappedBy 속성을 사용하지 않는다.
- 주인이 아니면 mappedBy 속성을 사용해서 속성의 값으로 연관관계의 주인을 지정해야 한다.

연관관계의 주인을 정한다는 것은 사실 외래 키 관리자를 선택하는 것이다.

### 5.4.2 연관관계의 주인은 외래 키가 있는 곳
연관관계의 주인만 데이터베이스 연관관계와 매핑되고 외래 키를 관리 할수있다. 주인이 아닌 반대편(inverse, non-owning side)은
읽기만 가능하고 외래 키를 변경하지는 못한다.

- 참고  
데이터베이스 테이블의 다대일, 일대다 관계에서는 항상 다 쪽이 외래 키를 가진다. 
다 쪽인 @ManyToOne은 항상 연관관계의 주인이 되므로 mappedBy를 설정할 수 없다.

## 5.5 양방향 연관관계 저장
```java
team1.getMembers().add(member1); // 무시(연관관계의 주인이 아님)
team1.getMembers().add(member2); // 무시(연관관계의 주인이 아님)
```

## 5.6 양방향 연관관계의 주의점
연관관계의 주인에는 값을 입력하지 않고, 주인이 아닌곳에만 값을 입력하는 것이다.
데이터베이스에 외래 키 값이 정상적으로 저장되지 않으면 이것부터 의심해보자.

### 5.6.1 순수한 객체까지 고려한 양방향 연관관계
객체 관점에서 양쪽 방향에 모두 값을 입력해는주는 것이 가장 안전하다. 
양쪽 방향 모두 값을 입력하지 않으면 JPA를 사용하지 않는 순수한 객체 상태에서 심각한 문제가 발생할 수 있다.

### 5.6.2 연관관계 편의 메소드
```java
public void setTeam(Team team) {
    this.team = team;
    team.getMembers().add(this);
}
```

### 5.6.3 연관관계 편의 메소드 작성 시 주의사항
```java
member1.setTeam(teamA);
member1.setTeam(teamB);
Member findMember = teamA.getMember(); //member1이 여전히 조회된다.
```
teamB로 변경할 때 teamA -> member1 관계를 제거하지 않았다.
```java
public void setTeam(Team team) {
    
    if (this.team != null) {
        this.team.getMembers().remove(this);    
    }
    
    this.tema = team;
    team.getMembers().add(this);
}
```

## 5.7 정리

