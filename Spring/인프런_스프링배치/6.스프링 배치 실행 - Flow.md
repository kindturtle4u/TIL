> 출처 : 인프런 스프링 배치 (장수원)

# 6.스프링 배치 실행 - Flow
## FlowJob - 개념 및 API 소개
- Job과 step은 상대적으로 고정되고 정해진 패턴과 순서 그런 흐름들을 구성
- flow라는 개념이 들어가게 되면 정해진 순서나 패턴이 아닌 유연하고 상대적으로 좀 복잡한 그런 흐름을 구성할 수 있습니다.

### 기본개념
- Step 을 순차적으로만 구성하는 것이 아닌 특정한 상태에 따라 흐름을 전환하도록 구성할 수 있으며 FlowJobBuilder 에 의해 생성된다
  * Step 이 실패 하더라도 Job 은 실패로 끝나지 않도록 해야 하는 경우
  * Step 이 성공 했을 때 다음에 실행해야 할 Step 을 구분해서 실행 해야 하는경우
  * 특정 Step은 전혀 실행되지 않게 구성 해야 하는 경우
- Flow 와 Job 의 흐름을 구성하는데만 관여하고 실제 비즈니스 로직은 Step 에서 이루어진다
- 내부적으로 SimpleFlow 객체를 포함하고 있으며 Job 실행 시 호출한다

### API 소개
- `JobBuilderFactory` > `JobBuilder` > `JobFlowBuilder` > `FlowBuilder` > `FlowJob`
```java
public Job batchJob() {
return jobBuilderFactory.get("batchJob")
          .start(Step) // Flow 시작하는 Step 설정
          .on(String pattern) // Step의 실행 결과로 돌려받는 종료상태 (ExitStatus)를 캐치하여 매칭하는 패턴, TransitionBuilder 반환
          .to(Step) // 다음으로 이동할 Step 지정
          .stop() / fail() / end() / stopAndRestart() //Flow를 중지 / 실패 / 종료 하도록 Flow 종료
          .from(Step) // 이전 단계에서 정의한 Step 의 Flow 를 추가적으로 정의함 
          .next(Step) // 다음으로 이동할 Step 지정
          .end() // build() 앞에 위치하면 FlowBuilder 를 종료하고 SimpleFlow 객체 생성
          .build(); // FlowJob 생성하고 flow 필드에 SimpleFlow 저장
}
```
- `Flow` : 흐름을 정의하는 역할 ( `start`, `from`, `next`)
- `Transition` : 조건에 따라 흐름을 전환시키는 역할 (`on`, `to`, `stop`, `fail`, `end`, `stopAndRestart`)
- 단순한 Step 으로 생성하는 SimpJob 보다 다양한 Flow 로 구성하는 FlowJob 의 생성 구조가 더 복잡하고 많은 API 를 제공한다
- FlowBuilder 의 on(String pattern) 메서드를 호출하게 되면 TransitionBuilder 가 작동하게 되면서 Step 간 조건부 전환을 구성할 수 있게 된다.

```java
public Job batchJob() {
    return jobBuilderFactory.get("batchJob")
            .start(step1())
            .on("COMPLETE").to(step3())
            .from(step1())
            .on("FAIL").to(step2())
            .end()
            .build();
}
```

## FlowJob - start() / next()
```java
@Bean
public Job batchJob() {
    return jobBuilderFactory.get("batchJob")
            .start(flowA())
            .next(step3())
            .next(flowB())
            .next(step6())
            .end()
            .build();
}

@Bean
public Flow flowA() {
    FlowBuilder<Flow> flowBuilder = new FlowBuilder<>("flowA");
    return flowBuilder.start(step1())
            .next(step2())
            .end()
            .build();
}

@Bean
public Flow flowB() {
  FlowBuilder<Flow> flowBuilder = new FlowBuilder<>("flowA");
  return flowBuilder.start(step4())
          .next(step5())
          .end()
          .build();
}
```
- 위의 구성은 Step을 Flow 별로 분리하여 구성하는 장점은 있지만 Step중 하나라도 실패할 경우 전체 Job이 실패하는 규칙은 동일하다.

## Transition - 배치상태 유형 (BatchStatus / ExitStatus / FlowExecutionStatus)
- Trasnsition 사전전의미: 전환된다, 전이된다.

### 배치 상태 유형
- BatchStatus / ExitStatus / FlowExecutionStatus

### BatchStatus
- JobExecution 과 StepExecution의 속성으로 Job 과 Step 의 종료 후 최종 결과 상태가 무엇인지 정의

#### SimpleJob
- 마지막 Step 의 BatchStatus 값을 Job 의 최종 BatchStatus 값으로 반영
- Step 이 실패할 경우 해당 Step 이 마지막 Step 이 된다

#### FlowJob
- Flow 내 Step 의 ExitStatus 값을 FlowExecutionStatus 값으로 저장
- 마지막 Flow 의 FlowExecutionStatus 값을 Job 의 최종 BatchStatus 값으로 반영

#### `COMPLETED`, `STARTING`, `STARTED`, `STOPPING`, `STOPPED`, `FAILED`, `ABANDONED`, `UNKNOWN`
- `ABANDONED` 는 처리를 완료했지만 성공하지 못한 단계와 재시작시 건너 뛰어야하는 단계 (FAILED 이나 재시작되지 않음)

### ExitStatus
- JobExecution 과 StepExecution의 속성으로 Job 과 Step 의 실행 후 어떤 상태로 종료되었는지 정의
- 기본적으로 ExitStatus 는 BatchStatus 와 동일한 값으로 설정된다

#### SimpleJob
- 마지막 Step 의 ExitStatus 값을 Job 의 최종 ExitStatus 값으로 반영

#### FlowJob
- Flow 내 Step 의 ExitStatus 값을 FlowExecutionStatus 값으로 저장
- 마지막 Flow 의 FlowExecutionStatus 값을 Job 의 최종 ExitStatus 값으로 반영

#### `UNKNOWN`, `EXECUTING`, `COMPLETED`, `NOOP`, `FAILED`, `STOPPED`
- exitCode 속성으로 참조

### FlowExecutionStatus
- FlowExecution 의 속성으로 Flow 의 실행 후 최종 결과 상태가 무엇인지 정의
- Flow 내 Step 이 실행되고 나서 ExitStatus 값을 FlowExecutionStatus 값으로 저장
- FlowJob 의 배치 결과 상태에 관여함
- `COMPLETED`, `STOPPED`, `FAILED`, `UNKNOWN`

## Transition - on() / to() / stop(), fail(), end(), stopAndRestart()

## 사용자 정의 ExitStatus

## JobExecutionDecider

## FlowJob 아키텍처

## SimpleFlow - 개념 및 API 소개

## SimpleFlow 예제

## SimpleFlow 아키텍처

## FlowStep

## @JobScope / @StepScope - 기본개념 및 설정

## @JobScope / @StepScope 아키텍처
