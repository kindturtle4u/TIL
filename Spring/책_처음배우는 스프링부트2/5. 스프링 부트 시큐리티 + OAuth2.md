> 출처 : 처음배우는 스프링부트2 읽으면서 정리

# 5. 스프링 부트 시큐리티 + OAuth2
스프링 부트 시큐리티는 스프링 시큐리티의 번거로운 설정을 간소화 시켜주는 래핑 프레임워크

스프링 시큐리티는 십여 년간의 보안 노하우를 쌓아 와서 
기본적인 틀 안에서 원하는 대로 인증,권한처리를 편리하게 관리할 수 있습니다.

## 5.1 배경지식 소개
### 5.1.1 스프링 부트 시큐리티
- 인증(authentication): 사용자(클라이언트)가 애플리케이션의 특정 동작에 관하여 허락(인증)된 사용자인지 확인하는 절차(보통 로그인)
- 권한부여(authorization): 데이터나 프로그램 등의 특정 자원이나 서비스에 접근할 수 있는 권한을 허용

### 5.1.2 OAuth2
OAuth는 토근을 사용한 범용적인 방법의 인증을 제공하는 표준 인증 프로토콜 입니다.

OAuth2에서 제공하는 승인 타입은 총 4가지 입니다.

- 권한 부여 코드 승인 타입(Authorization Code Grant Type): 클라이언트가 다른 사용자 대신 특정 리소스에 대한 접근을 요청할때
사용됩니다. 리소스 접근을 위한 사용자명과 비밀번호, 권한 서버에 요청해서 받은 권한 코드를 함께 활용하여 리소스에 대한
액세스 토근을 받으면 이를 인증에 이용하는 방식입니다.
- 암시적 승인 타입(Implicit Grant Type): 권한 부여 코드 승인 타입과 다르게 권한 코드 교환 단계 없이 액세스 토큰을 
즉시 반환받아 이를 인증에 이용하는 방식입니다.
- 리소스 소유자 암호 자격 증명 승인 타입(Resource Owner Password Credentials Grant Type): 클라이언트가 암호를 사용하여
액세스 토근에 대한 사용자의 자격 증명을 교환하는 방식입니다.
- 클라이언트 자격 증명 승인 타입(Client Credentials Grant Type): 클라이언트가 컨텍스트 외부에서 액세스 토근을 얻어
특정 리소스에 접근을 용청할 때 사용하는 방식
  
눈여겨볼 방식은 '권한 부여 코드 승인 타입'입니다. 왜냐하면 이장에서 적용하고자 하는
페이스북,구글,카카오 등의 소셜 미디어들이 웹서버 형태의 클라이언트를 지원하는데 이 방식을 사용하기 때문입니다.
이 방식은 웹 서버에서 장기 액세스 토근(long-lived access token)을 사용하여 사용자 인증을 처리합니다.

- 리소스 주인(resource owner) : 예) 인증이 필요한 사용자
- 클라이언트(clinet): 예) 웹사이트
- 권한 서버(authorization server): 예)페이스북/구글/카카오 서버
- 리소스 서버(resource server): 예)페이스북/구글/카카오 서버

1. 클라이언트가 파라미터로 클라이언트 ID,리다이렉트 URI,응답 타입을 code로 지정하여 권한 서버에 전달합니다.
정상적으로 인증이 되면 권한 부여 코드를 클라이언트에 보냅니다.
(응답 타입은 code,toekn이 사용가능합니다. 응답이 token일 때가 암시적 승인 타입에 해당합니다.)
   
2. 성공적으로 권한 부여 코드를 받은 클라이언트는 권한 부여 코드를 사용하여 액세스 토근(access token)을 권한 서버에 추가로 요청합니다.
이때 필요한 파라미터는 클라이언트ID (client-id), 클라이언트 비밀번호(client-secret),리다이렉트 URI,인증타입입니다.
   
3. 마지막으로 응답받은 액세스 토큰을 사용하여 리소스 서버에 사용자의 데이터를 요청합니다.

> https://velog.io/@piecemaker/OAuth2-%EC%9D%B8%EC%A6%9D-%EB%B0%A9%EC%8B%9D%EC%97%90-%EB%8C%80%ED%95%B4-%EC%95%8C%EC%95%84%EB%B3%B4%EC%9E%90

OAuth 2.0 동작방식
OAuth 인증 방식은 위에서 언급한 대로 인증의 과정을 '타 서비스에게 위임' 하는 인증 방식이다.
'위임'한다는 뜻은 내 웹 사이트에 '구글 로그인' 인증을 넣었다고 해서 사용자가 구글 웹 사이트에 
직접 로그인하는 것이 아니라는 뜻이다. 내 웹 사이트에 접속한 사용자의 정보는 여전히 내 웹 사이트에서 관리해야 한다.

구글이 해주는 일은 웹 사이트 사용자가 '구글 로그인' 기능을 통해 구글에게 전송한 구글 계정 정보가 유효한지(구글 아이디 및 비밀번호가 일치하는지)를 
확인한 후, 유효하다면 해당하는 구글 유저 정보 중 일부 (유저 이름, 프로필 이미지 등)를 내 웹 사이트에 제공해주는 
'인증' 과정만을 처리해주는 것 뿐이다.

## 5.2 스프링 부트 시큐리티 + OAuth2 설계하기
## 5.3 스프링 부트 시큐리티 + OAuth2 의존성 설정하기
build.gradle에 spring security OAuth2를 추가  
스프링부트 버전 1.5.14로 변경

## 5.4 스프링 부트 시큐리티 + OAuth2 구현하기
부록E '페이스북,구글,캌오 개발자 센터 연동' 참조하여 발급 후 진행

### 5.4.1 SNS 프로퍼티 설정 및 바인딩
- clientId: OAuth 클라언트 사용자명, OAuth 공급자가 클라이언트를 식별하는 데 사용합니다.
- clientSecret: OAuth 클라언트 시크릿 키값
- accessTokenUri: 액세스 토큰을 제공하는 OAuth의 URI
- userAuthorizationUri: 사용자가 리소스에 접근하는걸 승인하는 경우 리다이렉션할 URI
소셜 미디어에 따라 필요 없는 경우도 있습니다.
- scope: 리소스에 대한 접근 범위를 지정하는 문자열. 쉼표로 구분하여 여러개 지정할 수 있습니다.
- userInfoUri:사용자의 개인정보 조회를 위한 URI

### 5.4.2 시큐리티 + OAuth2 설정하기
- @EnableWebSecurity 어노테이션은 웹에서 시큐리티 기능을 사용하겠다는 어노테이션입니다.
스프링 부트에서는 @EnableWebSecurity를 사용하면 자동설정이 적용됩니다.
- 자동 설정 그대로 사용할 수도 있지만 요청,권한,기타 설정에 대해서는 필수적으로 최적화한 설정이 들어가야 합니다.
최적화 설정을 위해 WebSecurityConfigurerAdapter를 상속받고 configue(HttpSecurity http) 메서드를 오버라이드 하여 원하는 형식의
시큐리티를 설정합니다.

### 5.4.3 어노테이션 기반으로 User 정보 불러오기
HandlerMethodArgumentResolver  
컨트롤러 메서드에서 특정 조건에 해당하는 파라미터가 있으면 생성로직을 처리한 후 해당 파라미터에 바인딩해주는
전략 인터페이스 입니다. AOP로 모든 메서드를 일일이 찾아보면서 파라미터에 바인딩하는 방법보다 훨씬 빠르고 만들기도 편리합니다.

- supportsParameter() 메서드: HandlerMethodArgumentResolver가 해당하는 파라미터를 지원할지 여부를 반환합니다.
true를 반환하면 resovleArgument 메서드가 수행됩니다.
- resolveArgument() 메서드: 파라미터의 인잣값에 대한 정보를 바탕으로 실제 객체를 생성하여 해당 파라미터 객체에
바인딩 합니다.
  
### 5.4.4 인증 동작 확인하기
### 5.4.5 페이지 권한 분리하기

## 5.5 스프링 부트 2.0 기반 OAuth2 설정하기
### 5.5.1 스프링 부트 2.0 버전으로 의존성 업그레이드
### 5.5.2 스프링 부트 2.0 방식의 OAuth2 인증 재설정

## 5.6 마치며



  


